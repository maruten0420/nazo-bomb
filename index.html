<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bomb Defusal Mission</title>
    <link rel="icon" href="deco/bakudan.png" type="image/png">
    <meta property="og:title" content="Bomb Defusal Mission">
    <meta property="og:description" content="仕掛けられた**個の爆弾を解除せよ。">
    <meta property="og:image" content="bakudan-banner.png">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="bakudan-banner.png">
    <!-- デジタル時計風フォント -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0d0d0d;
            --panel-color: #1a1a1a;
            --text-color: #ffffff;
            --accent-red: #ff3333;
            /* ワイヤーの色定義 */
            --wire-red: #d93025;
            --wire-blue: #1a73e8;
            --wire-yellow: #f9ab00;
            --wire-green: #1e8e3e;
            --wire-black: #202124;
            --wire-white: #f1f3f4;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            background-image: 
                linear-gradient(rgba(30, 30, 30, 0.5) 1px, transparent 1px),
                linear-gradient(90deg, rgba(30, 30, 30, 0.5) 1px, transparent 1px),
                linear-gradient(45deg, transparent 48%, rgba(50, 20, 20, 0.1) 49%, rgba(50, 20, 20, 0.1) 51%, transparent 52%);
            background-size: 40px 40px, 40px 40px, 100% 100%;
            color: var(--text-color);
            font-family: 'Helvetica Neue', Arial, sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        body::after {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle, transparent 40%, #000 100%);
            pointer-events: none;
            z-index: 5;
        }

        .screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            background: transparent;
            transition: opacity 0.3s ease;
            z-index: 10;
        }

        .hidden {
            opacity: 0; pointer-events: none; z-index: -1; display: none !important;
        }

        /* --- タイトル & UI --- */
        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(2rem, 5vw, 4rem);
            color: var(--accent-red);
            text-shadow: 0 0 15px rgba(255, 51, 51, 0.6);
            margin-bottom: 2rem;
            text-align: center;
            letter-spacing: 2px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 4px;
            border: 1px solid #333;
        }

        .btn {
            background: linear-gradient(145deg, #333, #222);
            border: 1px solid #555;
            color: #fff;
            padding: 15px 40px;
            font-size: 1.2rem;
            margin: 10px;
            cursor: pointer;
            transition: all 0.2s;
            width: 240px;
            text-align: center;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
            font-family: 'Orbitron', sans-serif;
            z-index: 20;
        }
        .btn:active { transform: translateY(2px); box-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .btn:hover { border-color: var(--accent-red); color: var(--accent-red); }

        .settings-panel {
            background: rgba(10, 10, 10, 0.95);
            padding: 20px;
            border: 1px solid #444;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            width: 90%; max-width: 400px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            z-index: 20;
        }
        
        .slider-row {
            display: flex; align-items: center; margin: 15px 0;
            font-family: 'Orbitron', sans-serif;
        }
        .slider-label { width: 60px; text-align: right; margin-right: 15px; font-weight: bold; }
        input[type=range] { flex-grow: 1; cursor: pointer; }

        /* --- ゲーム画面 --- */
        #game-screen { justify-content: flex-start; padding: 2vh 2vw; }

        .timer-container {
            flex: 0 0 auto;
            background: #000;
            border: 4px solid #333;
            border-radius: 8px;
            padding: 5px 20px;
            margin-bottom: 2vh;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.3);
            display: flex; justify-content: center; align-items: center;
            width: 320px; min-width: 300px;
        }

        #timer-display {
            font-family: 'VT323', monospace;
            font-variant-numeric: tabular-nums;
            font-size: 5rem;
            color: #ff0000;
            letter-spacing: 4px;
            line-height: 1;
            text-align: center;
            width: 100%;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.7);
        }

        .puzzle-container {
            flex: 1 1 auto;
            width: 100%; max-width: 1000px;
            border: 2px dashed #555;
            background: rgba(0, 0, 0, 0.8);
            margin-bottom: 2vh;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; position: relative;
            border-radius: 4px;
            box-shadow: inset 0 0 30px #000;
        }

        #question-number {
            position: absolute; top: 10px; left: 10px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem; font-weight: bold;
            color: #fff; background: rgba(0, 0, 0, 0.7);
            padding: 5px 12px; border: 1px solid #555;
            border-radius: 4px; z-index: 10; pointer-events: none;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5); letter-spacing: 1px;
        }

        #puzzle-img {
            max-width: 100%; max-height: 100%;
            object-fit: contain; display: block;
        }

        /* --- ワイヤーエリア --- */
        .wires-container {
            flex: 0 0 25vh;
            width: 100%; max-width: 800px;
            display: flex; justify-content: space-around; align-items: center;
            background: #222;
            border: 1px solid #444; border-bottom: none;
            padding: 10px 0;
            border-radius: 8px 8px 0 0;
            position: relative;
            background: repeating-linear-gradient(45deg, #222, #222 10px, #1a1a1a 10px, #1a1a1a 20px);
            box-shadow: 0 -5px 15px rgba(0,0,0,0.5);
            z-index: 20;
        }

        .screw {
            position: absolute; width: 12px; height: 12px;
            background: linear-gradient(135deg, #777, #333);
            border-radius: 50%;
            box-shadow: 1px 1px 2px #000; border: 1px solid #222;
        }
        .screw::after {
            content: '+'; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); color: #222;
            font-size: 12px; line-height: 10px; font-family: sans-serif;
        }
        .screw.tl { top: 10px; left: 10px; }
        .screw.tr { top: 10px; right: 10px; }

        .wire-slot {
            position: relative; height: 100%; width: 14%;
            display: flex; justify-content: center;
            cursor: pointer; transition: transform 0.1s;
            /* 上下の穴の描画 */
            background-image: 
                radial-gradient(circle at center 12px, #000 0px, #000 6px, #333 7px, transparent 8px),
                radial-gradient(circle at center calc(100% - 12px), #000 0px, #000 6px, #333 7px, transparent 8px);
            background-repeat: no-repeat;
        }
        .wire-slot:active { transform: scale(0.95); }

        /* --- ワイヤー本体 --- */
        .wire {
            position: absolute;
            top: 12px; bottom: 12px; left: 50%;
            width: 14px; /* ワイヤー太さ */
            transform: translateX(-50%);
            border-radius: 4px;
            box-shadow: inset -4px 0 6px rgba(0,0,0,0.6), 4px 4px 6px rgba(0,0,0,0.6);
            z-index: 2;
            transition: background 0.1s;
            
            /* CSS変数初期値 (JSで書き換える) */
            --wire-color: #555;
            --angle-top: 15deg;
            --angle-bottom: -15deg;
        }

        /* 各色の設定（色を変数として保持） */
        .wire.red { --wire-color: var(--wire-red); background: var(--wire-color); }
        .wire.blue { --wire-color: var(--wire-blue); background: var(--wire-color); }
        .wire.yellow { --wire-color: var(--wire-yellow); background: var(--wire-color); }
        .wire.green { --wire-color: var(--wire-green); background: var(--wire-color); }
        .wire.black { --wire-color: var(--wire-black); background: var(--wire-color); border: 1px solid #444; }
        .wire.white { --wire-color: var(--wire-white); background: var(--wire-color); }

        /* --- 切断時のスタイル --- */
        .cut .wire {
            background: transparent !important; /* 元の棒は透明に */
            box-shadow: none; border: none;
        }

        /* 切断されたワイヤーの描画 (直線バージョンに戻しました) */
        /* 切断前の初期状態（透明でまっすぐ） */
        .wire::before,
        .wire::after {
            content: '';
            position: absolute;
            left: 50%;
            width: 14px;
            height: 45%;
            background: var(--wire-color);
            box-shadow: inset -4px 0 6px rgba(0,0,0,0.6), 4px 4px 6px rgba(0,0,0,0.6);
            transform: translateX(-50%) rotate(0deg);
            border-radius: 4px;
            opacity: 0; /* 切断されるまで隠す */
            transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1.0), opacity 0.1s ease;
            pointer-events: none;
        }

        /* 切断時の表示とアニメーション */
        .cut .wire::before,
        .cut .wire::after {
            opacity: 1;
        }

        /* 上半分 */
        .wire::before {
            top: 0; 
            transform-origin: top center;
            /* 断面 */
            border-bottom: 4px solid #b87333; 
        }
        .cut .wire::before {
            transform: translateX(-50%) rotate(var(--angle-top)); 
        }

        /* 下半分 */
        .wire::after {
            bottom: 0;
            transform-origin: bottom center;
            /* 断面 */
            border-top: 4px solid #b87333;
        }
        .cut .wire::after {
            transform: translateX(-50%) rotate(var(--angle-bottom));
        }

        /* 黒ワイヤーの場合だけborderが見えなくなるので微調整 */
        .cut .wire.black::before, .cut .wire.black::after {
            border: 1px solid #444;
            border-top: none; border-bottom: none;
        }
        .cut .wire.black::before { border-bottom: 4px solid #b87333; }
        .cut .wire.black::after { border-top: 4px solid #b87333; }


        /* --- ゲームオーバー・クリア演出 --- */
        #gameover-screen { background-color: rgba(20, 0, 0, 0.95); z-index: 50; }
        .status-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 4rem;
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
        }
        .text-explode { color: #ff0000; animation: blink 0.2s infinite alternate; }
        .text-clear { color: #00ff00; text-shadow: 0 0 20px #00ff00; }

        @keyframes blink { from { opacity: 1; } to { opacity: 0.3; } }

    </style>
</head>
<body>

    <audio id="bgm" loop preload="auto"><source src="deco/bgm.mp3" type="audio/mpeg"></audio>
    <audio id="se-cut" preload="auto"><source src="deco/se_cut.mp3" type="audio/mpeg"></audio>
    <audio id="se-explode" preload="auto"><source src="deco/se_explode.mp3" type="audio/mpeg"></audio>
    <audio id="se-clear" preload="auto"><source src="deco/se_clear.mp3" type="audio/mpeg"></audio>
    <audio id="se-timer" preload="auto"><source src="deco/se_timer.mp3" type="audio/mpeg"></audio>

    <div id="title-screen" class="screen">
        <h1>BOMB DEFUSAL</h1>
        <div class="btn" onclick="Game.start()">MISSION START</div>
        <div class="btn" onclick="UI.toggleSettings()">SETTINGS</div>
        <div class="btn" onclick="UI.showHelp()">INSTRUCTIONS</div>

        <div id="settings-panel" class="settings-panel hidden">
            <h3 style="font-family:'Orbitron'; color:#aaa; margin-top:0;">SYSTEM SETTINGS</h3>
            <div class="slider-row">
                <div class="slider-label">BGM</div>
                <input type="range" id="vol-bgm" min="0" max="1" step="0.1" value="0.3" oninput="AudioMgr.updateVolume()">
            </div>
            <div class="slider-row">
                <div class="slider-label">SE</div>
                <input type="range" id="vol-se" min="0" max="1" step="0.1" value="0.8" oninput="AudioMgr.updateVolume()">
            </div>
            <div class="btn" style="width:120px; padding:10px; margin-top:10px;" onclick="UI.toggleSettings()">CLOSE</div>
        </div>
    </div>

    <div id="game-screen" class="screen hidden">
        <div class="timer-container">
            <span id="timer-display">30.00</span>
        </div>
        <div class="puzzle-container">
            <div id="question-number">Q. 000</div>
            <img id="puzzle-img" src="" alt="Cryptic Puzzle">
        </div>
        <div class="wires-container">
            <div class="screw tl"></div><div class="screw tr"></div>
            <!-- 引数: 0=赤, 1=青, 2=黄, 3=緑, 4=黒, 5=白 -->
            <div class="wire-slot" onclick="Game.cutWire(0)"><div class="wire red"></div></div>
            <div class="wire-slot" onclick="Game.cutWire(1)"><div class="wire blue"></div></div>
            <div class="wire-slot" onclick="Game.cutWire(2)"><div class="wire yellow"></div></div>
            <div class="wire-slot" onclick="Game.cutWire(3)"><div class="wire green"></div></div>
            <div class="wire-slot" onclick="Game.cutWire(4)"><div class="wire black"></div></div>
            <div class="wire-slot" onclick="Game.cutWire(5)"><div class="wire white"></div></div>
        </div>
    </div>

    <div id="gameover-screen" class="screen hidden">
        <div id="gameover-text" class="status-text text-explode">EXPLODED</div>
        <div class="btn" onclick="location.reload()">RETRY MISSION</div>
        <!-- <div class="btn" onclick="Game.shareOnX()" style="background: #000; border-color: #555; margin-top: 10px;">REPORT X</div> -->
    </div>

    <div id="clear-screen" class="screen hidden" style="background: #001a00;">
        <div class="status-text text-clear">BOMB DEFUSED</div>
        <div style="margin-bottom:20px; color:#aaa;">All systems normalized.</div>
        <div class="btn" onclick="location.reload()">RETURN TO BASE</div>
        <!-- <div class="btn" onclick="Game.shareOnX()" style="background: #000; border-color: #555; margin-top: 10px;">REPORT X</div> -->
    </div>

    <script>
        /**
         * ============================================================
         * 設定エリア：問題リスト
         * -----------------------------------------------------------
         */
        const PROBLEM_LIST = [
            "001_100000.png",  
            "002_000100.png",  
            "003_000100.png",  
            "004_100000.png", 
            "005_011111.png", 
            "006_001101.png",
            "007_010010.png",
            "008_000001.png",
            "009_110111.png",
            "010_000001.png",
            "011_000001.png",
            "012_000010.png",
            "013_000010.png",
            "014_101111.png",
            "015_100000.png",
            "016_100000.png",
            "017_000100.png",
            "018_100001.png",
            "019_100000.png",
            "020_001000.png",
            "021_001000.png",
            "022_000001.png",
            "023_111111.png",
            "024_010000.png",
            "025_010000.png",
            // ここにファイル名を追加...
        ];

        const AudioMgr = {
            bgm: document.getElementById('bgm'),
            seCut: document.getElementById('se-cut'),
            seExplode: document.getElementById('se-explode'),
            seClear: document.getElementById('se-clear'),
            seTimer: document.getElementById('se-timer'),

            init: function() {
                // ローカルストレージから設定を読み込む
                const savedBgm = localStorage.getItem('bomb_bgm_vol');
                const savedSe = localStorage.getItem('bomb_se_vol');

                // 保存された値があればスライダーに適用
                if (savedBgm !== null) {
                    document.getElementById('vol-bgm').value = savedBgm;
                }
                if (savedSe !== null) {
                    document.getElementById('vol-se').value = savedSe;
                }

                // 音量を適用
                this.updateVolume();
                this.bgm.loop = true;
            },

            updateVolume: function() {
                const bgmVol = document.getElementById('vol-bgm').value;
                const seVol = document.getElementById('vol-se').value;

                this.bgm.volume = bgmVol;
                this.seCut.volume = seVol;
                this.seExplode.volume = seVol;
                this.seClear.volume = seVol;
                this.seTimer.volume = seVol;

                // 変更された値を保存
                localStorage.setItem('bomb_bgm_vol', bgmVol);
                localStorage.setItem('bomb_se_vol', seVol);
            },

            playBGM: function() {
                this.bgm.currentTime = 0;
                this.bgm.play().catch(e => console.log("Auto-play blocked:", e));
            },

            stopBGM: function() {
                this.bgm.pause();
            },

            playCut: function() {
                this.seCut.currentTime = 0;
                this.seCut.play();
            },

            playExplode: function() {
                this.stopBGM();
                this.seExplode.play();
            },

            playClear: function() {
                this.stopBGM();
                this.seClear.play();
            },

            playTimer: function() {
                this.seTimer.currentTime = 0;
                this.seTimer.play().catch(e => {});
            }
        };

        const UI = {
            screens: {
                title: document.getElementById('title-screen'),
                game: document.getElementById('game-screen'),
                gameover: document.getElementById('gameover-screen'),
                clear: document.getElementById('clear-screen')
            },

            showScreen: function(screenName) {
                Object.values(this.screens).forEach(el => el.classList.add('hidden'));
                if(this.screens[screenName]) {
                    this.screens[screenName].classList.remove('hidden');
                }
            },

            toggleSettings: function() {
                const panel = document.getElementById('settings-panel');
                panel.classList.toggle('hidden');
            },

            showHelp: function() {
                alert(
                    "【MISSION BRIEFING】\n\n" +
                    "時限爆弾の解除コードを切断せよ。\n" +
                    "コードの色は「赤・青・黄・緑・黒・白」の6つ。\n" +
                    "上部のモニターに表示される謎が解除コードのヒントだ。\n\n" +
                    "■ ルール\n" +
                    "1. 正解の色のワイヤーを全て切れ。\n" +
                    "2. 間違った色を切ると即爆発。\n" +
                    "3. 制限時間が0になると爆発。\n\n" +
                    "正解ワイヤーを全て切るとタイマーが少しずつ回復し、次の問題へ進む。\n" +
                    "諸君の健闘を祈る。"
                );
            },

            updateTimer: function(time) {
                const displayVal = time > 99.99 ? 99.99 : time;
                document.getElementById('timer-display').innerText = displayVal.toFixed(2);
            },

            updateQuestionNumber: function(num) {
                const paddedNum = String(num).padStart(3, '0');
                document.getElementById('question-number').innerText = "Q. " + paddedNum;
            },

            setPuzzleImage: function(fileName) {
                document.getElementById('puzzle-img').src = "nazo/" + fileName;
                document.getElementById('puzzle-img').onerror = function() {
                    console.error("Image load failed: " + fileName);
                };
            },

            resetWires: function() {
                const slots = document.querySelectorAll('.wire-slot');
                slots.forEach(slot => {
                    slot.classList.remove('cut');
                    // CSS変数をリセット
                    const wire = slot.querySelector('.wire');
                    if(wire) {
                        wire.style.removeProperty('--angle-top');
                        wire.style.removeProperty('--angle-bottom');
                    }
                });
            }
        };

        const Game = {
            timeLeft: 30.00,
            timerId: null,
            problems: [],
            currentProblemIdx: 0,
            currentSolution: [], 
            currentCutState: [],
            isActive: false,

            start: function() {
                if (PROBLEM_LIST.length === 0) {
                    alert("No problems found in PROBLEM_LIST.");
                    return;
                }
                this.problems = [...PROBLEM_LIST].sort(() => Math.random() - 0.5);
                
                this.isActive = true;
                this.timeLeft = 30.00;
                this.currentProblemIdx = 0;
                
                AudioMgr.init();
                AudioMgr.playBGM();
                
                UI.showScreen('game');
                this.loadProblem();
                this.startTimer();
            },

            loadProblem: function() {
                if (this.currentProblemIdx >= this.problems.length) {
                    this.missionComplete();
                    return;
                }

                const fileName = this.problems[this.currentProblemIdx];
                const match = fileName.match(/_([01]{6})\./);
                if (!match) {
                    console.error("Invalid filename format:", fileName);
                    this.currentProblemIdx++;
                    this.loadProblem();
                    return;
                }

                this.currentSolution = match[1].split('').map(Number);
                this.currentCutState = [0, 0, 0, 0, 0, 0];
                
                UI.updateQuestionNumber(this.currentProblemIdx + 1);
                UI.resetWires();
                UI.setPuzzleImage(fileName);
            },

            startTimer: function() {
                if (this.timerId) clearInterval(this.timerId);
                this.timerId = setInterval(() => {
                    if (!this.isActive) return;

                    const prevTimeCeil = Math.ceil(this.timeLeft);
                    this.timeLeft -= 0.01;
                    this.timeLeft = Math.round(this.timeLeft * 100) / 100;

                    if (this.timeLeft <= 0) {
                        this.timeLeft = 0;
                        this.gameOver('timeout');
                    }

                    const currentTimeCeil = Math.ceil(this.timeLeft);
                    if (currentTimeCeil < prevTimeCeil && this.timeLeft > 0) {
                        AudioMgr.playTimer();
                    }

                    UI.updateTimer(this.timeLeft);
                }, 10);
            },

            cutWire: function(wireIndex) {
                if (!this.isActive) return;
                
                if (this.currentCutState[wireIndex] === 1) return;

                AudioMgr.playCut();

                const slot = document.querySelectorAll('.wire-slot')[wireIndex];
                const wire = slot.querySelector('.wire');
                
                // === 直線の角度をランダム生成 ===
                // 角度をランダムに決定 (-15deg ~ 15deg 程度)
                const angleTop = (Math.random() - 0.5) * 30;
                const angleBottom = (Math.random() - 0.5) * 30;

                // CSS変数に適用
                wire.style.setProperty('--angle-top', `${angleTop}deg`);
                wire.style.setProperty('--angle-bottom', `${angleBottom}deg`);

                slot.classList.add('cut');
                this.currentCutState[wireIndex] = 1;

                if (this.currentSolution[wireIndex] === 0) {
                    this.gameOver('explode');
                } else {
                    this.checkProgress();
                }
            },

            checkProgress: function() {
                let remaining = false;
                for (let i = 0; i < 6; i++) {
                    if (this.currentSolution[i] === 1 && this.currentCutState[i] === 0) {
                        remaining = true;
                        break;
                    }
                }

                if (!remaining) {
                    this.problemCleared();
                }
            },

            problemCleared: function() {
                const correctCount = this.currentSolution.filter(bit => bit === 1).length;
                const recovery = Math.max(5 - ((correctCount - 1) * 0.1), 1.0);
                
                this.timeLeft += recovery;
                if(this.timeLeft > 99.99) this.timeLeft = 99.99;
                
                this.currentProblemIdx++;
                this.loadProblem();
            },

            gameOver: function(reason) {
                this.isActive = false;
                clearInterval(this.timerId);
                AudioMgr.playExplode();
                
                const textEl = document.getElementById('gameover-text');
                if (reason === 'timeout') {
                    textEl.innerText = "TIME OVER";
                } else {
                    textEl.innerText = "EXPLODED";
                }

                UI.showScreen('gameover');
            },

            missionComplete: function() {
                this.isActive = false;
                clearInterval(this.timerId);
                AudioMgr.playClear();
                UI.showScreen('clear');
            },

            shareOnX: function() {
                const count = this.currentProblemIdx;
                const text = `私は${count}個の爆弾を解除しました！\n↓あなたも爆弾を解除しよう↓\nhttps://maruten0420.github.io/nazo-bomb/\n#BOMB_DEFUSAL #謎解き`;
                const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
                window.open(url, '_blank');
            }
        };

        window.onload = function() {
            AudioMgr.init();
        };

    </script>
</body>
</html>
